---
title: "CDM2009_Exploratory"
author: "Trevor Ruiz"
date: "December 26, 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
options(stringsAsFactors = F)
library(dplyr)
library(tidyr)
library(lubridate)
library(ggplot2)
library(ggmap)
library(xtable)
library(pander)
raw_data <- read.csv('cdm_data.csv')
str(raw_data)

sub_data <- raw_data %>%
  transmute(date = as.Date(Symptom_date, origin = '2009-01-01'),
         state = State,
         county = County,
         planting = Planting,
         host = Host,
         field_size = Field.size..Acres.,
         incidence = Dis_incid,
         severity = Dis_sev,
         occurrence = (Dis_sev != 0),
         lat = Latitude,
         long = Longitude) # variables of interest

locations <- distinct(sub_data, lat, long) %>%
  mutate(locID = 1:(nrow(distinct(sub_data, lat, long))))

data <- merge(sub_data, locations, by = c('lat', 'long'))
```

## Variable summaries
```{r variables}
n_distinct(data$county)
n_distinct(data$state)
n_distinct(data$locID)
n_distinct(data$host)
```

## Counts of disease occurrence by host and planting 
```{r tables}
tbl <- xtabs(occurrence ~ state + host + planting, 
             data = data)
apply(tbl, c(3, 2), sum) %>%
  pander()
```


## Distribution of occurrences in time by planting and host
```{r time1, echo = F}
ggplot(aes(x = yday(date),
           color = host),
       data = data) +
  geom_density(adjust = 0.75) +
  facet_wrap(~host*planting, 
             drop = F, nrow = 5)
```


## Distribution of occurrences in time by host
```{r time2, echo = F}
ggplot(aes(x = yday(date),
           color = host),
       data = data) +
  geom_density(adjust = 0.75)
```

## Distribution of occurrences per state by host and planting
```{r perstate1, echo = F}
plot_df1 <- group_by(data, state, host, planting) %>%
  summarize(statewide_occurrences = sum(occurrence),
            mean_sev = mean(severity),
            mean_inc = mean(incidence))
                    
ggplot(aes(x = statewide_occurrences,
           color = host), 
       data = plot_df1) +
  geom_density(adjust = 0.8) +
  facet_wrap(~host*planting, 
             drop = F, nrow = 5)
```

## Distribution of occurrences per state by host
```{r perstate2, echo = F}
plot_df1 <- group_by(data, state, host, planting) %>%
  summarize(statewide_occurrences = sum(occurrence),
            mean_sev = mean(severity),
            mean_inc = mean(incidence))
                    
ggplot(aes(x = statewide_occurrences,
           color = host), 
       data = plot_df1) +
  geom_density(adjust = 1.5)
```


```{r mapsetup, echo = F, include = F}
plot_df2 <- group_by(data, locID, host, planting) %>%
  summarize(init_date = min(date)) %>% 
  merge(locations, by = 'locID')

bbox <- make_bbox(locations$long, locations$lat)
map <- get_stamenmap(bbox, zoom = calc_zoom(bbox), maptype = 'toner')
```

## Map of initial occurrences by host with temporal gradient
```{r map2, echo = F}
ggmap(map, darken = c(0.4, "white"), extent = 'normal') +
  geom_point(aes(x = long, y = lat, color = yday(init_date)),
             data = plot_df2) +
  facet_wrap(~host) +
  scale_color_gradientn(colors = terrain.colors(100))
```

## Map of initial occurrences with temporal gradient
```{r map3, echo = F}
ggmap(map, darken = c(0.4, "white"), extent = 'normal') +
  geom_point(aes(x = long, y = lat, color = yday(init_date)),
             data = plot_df2) +
  scale_color_gradientn(colors = terrain.colors(100))
```
